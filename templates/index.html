<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Tic-Tac-Toe</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ‚îÄ‚îÄ DARK THEME (default) ‚îÄ‚îÄ */
        :root {
            --bg: #111111;
            --surface: #1a1a1a;
            --border: #2a2a2a;
            --x-color: #c0392b;
            --o-color: #2980b9;
            --x-glow: rgba(192, 57, 43, 0.25);
            --o-glow: rgba(41, 128, 185, 0.25);
            --text: #e8e8e8;
            --muted: #666666;
            --accent: #d4a843;
            --input-bg: #111111;
        }


        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Mono', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 16px;
            transition: background 0.25s, color 0.25s;
        }

        .wrapper {
            width: 100%;
            max-width: 1100px;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            letter-spacing: 3px;
            color: var(--text);
        }

        .version-tag {
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--muted);
            text-transform: uppercase;
            margin-left: 10px;
            vertical-align: middle;
        }

        .header-btns { display: flex; gap: 10px; }

        .btn {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            padding: 8px 18px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        .btn:hover { border-color: var(--muted); background: var(--border); }
        .btn.primary {
            border-color: var(--accent);
            color: var(--accent);
        }
        .btn.primary:hover { background: rgba(240,192,96,0.1); }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #loginScreen {
            max-width: 420px;
            margin: 80px auto;
        }

        .login-eyebrow {
            font-size: 11px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 12px;
        }

        .login-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 48px;
            letter-spacing: 2px;
            line-height: 1;
            margin-bottom: 8px;
        }

        .login-sub {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 36px;
        }

        .field {
            margin-bottom: 16px;
        }

        .field label {
            display: block;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .field input {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 13px 16px;
            font-family: 'DM Mono', monospace;
            font-size: 14px;
            color: var(--text);
            transition: border-color 0.2s;
        }

        .field input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 3px;
            color: #1a1a1a;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }

        .login-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .login-btn:active { transform: translateY(0); }

        .login-hint {
            text-align: center;
            font-size: 11px;
            color: var(--muted);
            margin-top: 14px;
        }

        /* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
        #gameScreen { display: none; }
        #gameScreen.show { display: block; }

        /* User bar */
        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 20px;
        }

        .user-left { display: flex; align-items: center; gap: 16px; }

        .rank-icon {
            width: 42px;
            height: 42px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--x-color), var(--o-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: #fff;
        }

        .user-name-display {
            font-size: 15px;
            font-weight: 500;
        }

        .user-stats-bar {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }

        .stat-w { color: var(--x-color); }
        .stat-l { color: var(--o-color); }
        .stat-d { color: var(--muted); }
        
        .rank-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* Status */
        #status {
            text-align: center;
            padding: 14px;
            border-radius: 8px;
            font-size: 15px;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 18px;
            border: 1px solid var(--border);
            background: var(--surface);
            transition: all 0.3s;
        }

        #status.waiting { color: var(--accent); border-color: var(--border); }
        #status.playing { color: var(--muted); }
        #status.your-turn { color: var(--x-color); border-color: var(--border); }
        #status.opp-turn  { color: var(--o-color); border-color: var(--border); }

        .find-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto 24px;
            padding: 14px;
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 3px;
            color: var(--accent);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .find-btn:hover { background: rgba(240,192,96,0.08); transform: translateY(-1px); }
        .find-btn:active { transform: translateY(0); }

        /* Players display */
        .players-bar {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 24px;
            margin-bottom: 18px;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .players-bar.show { display: flex; }

        .player-tag {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .player-tag.right { justify-content: flex-end; }

        .piece-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .piece-icon.x { background: rgba(192,57,43,0.1); color: var(--x-color); border: 1px solid rgba(192,57,43,0.2); }
        .piece-icon.o { background: rgba(41,128,185,0.1); color: var(--o-color); border: 1px solid rgba(41,128,185,0.2); }

        .player-tag-name { font-size: 14px; }
        .player-tag-name.active { color: var(--accent); font-weight: 500; }

        .vs-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--muted);
            letter-spacing: 2px;
        }

        /* ‚îÄ‚îÄ GAME LAYOUT ‚îÄ‚îÄ */
        .game-layout {
            display: none;
            gap: 20px;
            align-items: flex-start;
        }

        .game-layout.show { display: flex; }

        .board-section { flex: 1; min-width: 280px; }

        /* ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ */
        #board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 420px;
            margin: 0 auto;
        }

        .cell {
            aspect-ratio: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(52px, 10vw, 88px);
            cursor: pointer;
            position: relative;
            transition: border-color 0.2s, background 0.2s, transform 0.1s;
            user-select: none;
            overflow: hidden;
        }

        .cell:hover:not(.taken) {
            border-color: var(--muted);
            background: var(--border);
            transform: scale(1.02);
        }

        .cell.taken { cursor: default; }

        .cell .piece {
            transition: opacity 0.4s, transform 0.3s;
            line-height: 1;
        }

        /* Fading piece - will disappear next turn */
        .cell .piece.fading {
            opacity: 0.3;
        }

        /* Pulse ring on fading cell */
        .cell.fading-cell::after {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 10px;
            border: 2px dashed var(--muted);
            animation: dashSpin 3s linear infinite;
            pointer-events: none;
        }

        @keyframes dashSpin {
            to { transform: rotate(360deg); }
        }

        /* Color per piece type */
        .cell .piece.x { color: var(--x-color); }
        .cell .piece.o { color: var(--o-color); }

        /* Win highlight */
        .cell.win-cell {
            background: rgba(240,192,96,0.08);
            border-color: var(--accent);
            animation: winPulse 0.8s ease infinite alternate;
        }

        @keyframes winPulse {
            from { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
            to   { box-shadow: 0 0 0 3px var(--accent); }
        }

        /* Drop-in animation */
        @keyframes dropIn {
            0%   { transform: scale(0.4) rotate(-8deg); opacity: 0; }
            70%  { transform: scale(1.12) rotate(2deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .piece.just-placed {
            animation: dropIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Disappear animation */
        @keyframes vanish {
            0%   { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(0); opacity: 0; }
        }

        .piece.vanishing {
            animation: vanish 0.2s ease-in forwards;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 16px;
            font-size: 11px;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
        }
        .legend-dot.solid { background: var(--x-color); }
        .legend-dot.faded { background: var(--muted); border: 1px dashed var(--muted); }

        /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
        .chat-section {
            flex: 0 0 360px;
            min-width: 280px;
            display: flex;
            flex-direction: column;
        }

        .chat-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 520px;
        }

        .chat-head {
            padding: 12px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .chat-head-left { display: flex; align-items: center; gap: 8px; }

        .chat-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--accent);
        }

        .unread-pill {
            background: var(--x-color);
            color: #fff;
            font-size: 10px;
            padding: 1px 7px;
            border-radius: 10px;
            display: none;
        }

        .chat-toggle-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: color 0.2s;
        }

        .chat-toggle-btn:hover { color: var(--text); }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .msg {
            display: flex;
            flex-direction: column;
            max-width: 78%;
            animation: msgIn 0.2s ease;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg.own { align-self: flex-end; }
        .msg.opp { align-self: flex-start; }

        .msg-sender {
            font-size: 10px;
            color: var(--muted);
            margin-bottom: 4px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .msg-bubble {
            padding: 9px 13px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            word-break: break-word;
        }

        .msg.own .msg-bubble {
            background: rgba(192,57,43,0.1);
            border: 1px solid rgba(192,57,43,0.2);
            color: var(--text);
            border-bottom-right-radius: 3px;
        }

        .msg.opp .msg-bubble {
            background: rgba(41,128,185,0.08);
            border: 1px solid rgba(41,128,185,0.18);
            color: var(--text);
            border-bottom-left-radius: 3px;
        }

        .msg-time { font-size: 10px; color: var(--muted); margin-top: 3px; }
        .msg.own .msg-time { text-align: right; }

        .sys-msg {
            text-align: center;
            font-size: 11px;
            color: var(--muted);
            letter-spacing: 1px;
            padding: 4px 0;
        }

        .chat-input-row {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        #chatInput {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 13px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--text);
            transition: border-color 0.2s;
        }

        #chatInput:focus { outline: none; border-color: var(--muted); }

        #sendBtn {
            background: rgba(240,192,96,0.1);
            border: 1px solid rgba(240,192,96,0.3);
            border-radius: 8px;
            padding: 10px 18px;
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--accent);
            cursor: pointer;
            letter-spacing: 1px;
            transition: background 0.2s;
        }

        #sendBtn:hover { background: rgba(240,192,96,0.18); }

        /* ‚îÄ‚îÄ LEADERBOARD MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(4px);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show { display: flex; }

        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            width: 90%;
            max-width: 580px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalIn 0.25s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(12px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.2s, border-color 0.2s;
        }

        .modal-close:hover { color: var(--text); border-color: var(--muted); }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        tbody td {
            padding: 12px;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        tbody tr:hover td { background: rgba(255,255,255,0.02); }

        .rank-num { font-family: 'Bebas Neue', sans-serif; font-size: 20px; }
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .lb-you { color: var(--accent); font-weight: 500; }
        .lb-winrate { color: #4dff91; }
        .lb-me-row td { background: rgba(240,192,96,0.04) !important; }

        /* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
        .timer-bar {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .timer-bar.show { display: flex; }

        .timer-track {
            flex: 1;
            max-width: 320px;
            height: 6px;
            background: var(--border);
            border-radius: 99px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            width: 100%;
            border-radius: 99px;
            background: var(--accent);
            transition: width 1s linear, background 0.3s;
        }

        .timer-fill.urgent { background: var(--x-color); }

        .timer-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            min-width: 28px;
            text-align: center;
            color: var(--accent);
            transition: color 0.3s;
        }

        .timer-num.urgent { color: var(--x-color); }

        /* ‚îÄ‚îÄ MATCH SCORE ‚îÄ‚îÄ */
        .match-bar {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 14px;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .match-bar.show { display: flex; }

        .match-label {
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .match-scores {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-pip-group { display: flex; gap: 5px; }

        .match-pip {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: transparent;
            transition: background 0.3s, border-color 0.3s;
        }

        .match-pip.won-x { background: var(--x-color); border-color: var(--x-color); }
        .match-pip.won-o { background: var(--o-color); border-color: var(--o-color); }

        .match-divider {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: var(--muted);
        }

        /* ‚îÄ‚îÄ REMATCH / END SCREEN ‚îÄ‚îÄ */
        .end-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(6px);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }

        .end-overlay.show { display: flex; }

        .end-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            min-width: 300px;
            animation: modalIn 0.3s ease;
        }

        .end-emoji { font-size: 56px; margin-bottom: 12px; }

        .end-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 42px;
            letter-spacing: 2px;
            margin-bottom: 6px;
        }

        .end-sub {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 28px;
        }

        .end-match-score {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 20px;
        }

        .end-match-score span { color: var(--text); font-weight: bold; }

        .end-btns { display: flex; gap: 12px; justify-content: center; }

        .rematch-btn {
            padding: 12px 28px;
            background: rgba(240,192,96,0.1);
            border: 1px solid var(--accent);
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 2px;
            color: var(--accent);
            cursor: pointer;
            transition: background 0.2s;
        }

        .rematch-btn:hover { background: rgba(240,192,96,0.2); }
        .rematch-btn:disabled { opacity: 0.4; cursor: default; }

        .leave-btn {
            padding: 12px 28px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            letter-spacing: 2px;
            color: var(--muted);
            cursor: pointer;
            transition: border-color 0.2s, color 0.2s;
        }

        .leave-btn:hover { border-color: var(--muted); color: var(--text); }

        .rematch-waiting {
            font-size: 12px;
            color: var(--muted);
            margin-top: 12px;
            letter-spacing: 1px;
            min-height: 18px;
        }
        @media (max-width: 860px) {
            .game-layout.show { flex-direction: column; }
            .chat-section { flex: 1; width: 100%; }
            .chat-box { min-height: 320px; }
        }


        /* ‚îÄ‚îÄ DEBUG CONSOLE ‚îÄ‚îÄ */
        #debugConsole {
            position: fixed;
            top: 0; left: 0;
            width: 300px;
            height: 100vh;
            background: #050508;
            border-right: 1px solid #1a1a2e;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            transform: translateX(-100%);
            transition: transform 0.25s ease;
        }
        #debugConsole.open { transform: translateX(0); }
        .dbg-header {
            padding: 10px 14px;
            background: #0a0a14;
            border-bottom: 1px solid #1a1a2e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .dbg-title { color: #4dff91; letter-spacing: 2px; font-size: 10px; text-transform: uppercase; }
        .dbg-close { background: none; border: none; color: #5a5a7a; cursor: pointer; font-size: 16px; line-height: 1; }
        .dbg-close:hover { color: #e8e8f0; }
        .dbg-state {
            padding: 10px 14px;
            border-bottom: 1px solid #1a1a2e;
            flex-shrink: 0;
            color: #5a5a7a;
            line-height: 1.9;
            font-size: 10px;
        }
        .dbg-state .v { color: #e8e8f0; }
        .dbg-state .vx { color: #ff4d6d; }
        .dbg-state .vo { color: #4dc9ff; }
        .dbg-state .vg { color: #4dff91; }
        #dbgLog {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #1a1a2e transparent;
        }
        .dl { padding: 2px 5px; border-radius: 3px; line-height: 1.5; word-break: break-all; font-size: 10px; }
        .dl.info  { color: #6a6a8a; }
        .dl.ok    { color: #4dff91; background: rgba(77,255,145,0.05); }
        .dl.warn  { color: #f0c060; background: rgba(240,192,96,0.06); }
        .dl.err   { color: #ff4d6d; background: rgba(255,77,109,0.08); }
        .dl.evt   { color: #4dc9ff; }
        .dl.move  { color: #c084fc; }
        .dl.turn  { color: #f0c060; }
        .dl.state { color: #4dff91; }
        .dl-t { color: #2a2a4a; margin-right: 5px; }
        .dbg-footer {
            padding: 8px;
            border-top: 1px solid #1a1a2e;
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .dbg-btn {
            flex: 1; padding: 5px;
            background: #0f0f1a;
            border: 1px solid #1a1a2e;
            border-radius: 4px;
            color: #5a5a7a;
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .dbg-btn:hover { color: #e8e8f0; border-color: #5a5a7a; }
        #debugToggle {
            position: fixed;
            top: 50%; left: 0;
            transform: translateY(-50%);
            background: #0a0a14;
            border: 1px solid #1a1a2e;
            border-left: none;
            border-radius: 0 6px 6px 0;
            padding: 12px 5px;
            cursor: pointer;
            z-index: 10000;
            writing-mode: vertical-lr;
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            color: #4dff91;
            text-transform: uppercase;
        }
        #debugToggle:hover { background: #0f0f20; }
    

        /* ‚îÄ‚îÄ SHOP MODAL ‚îÄ‚îÄ */
        #shopModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }
        #shopModal.show { display: flex; }

        .shop-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            width: 560px;
            max-width: 95vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .shop-head {
            padding: 20px 24px 0;
            flex-shrink: 0;
        }

        .shop-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .shop-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            letter-spacing: 2px;
        }

        .shop-coins {
            font-size: 13px;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .shop-close {
            position: absolute;
            top: 16px; right: 20px;
            background: none; border: none;
            color: var(--muted); font-size: 18px;
            cursor: pointer; line-height: 1;
        }
        .shop-close:hover { color: var(--text); }

        .shop-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }

        .shop-tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--muted);
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
            margin-bottom: -1px;
        }
        .shop-tab:hover { color: var(--text); }
        .shop-tab.active { color: var(--text); border-bottom-color: var(--accent); }

        .shop-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
        }

        .skin-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: border-color 0.15s;
        }
        .skin-card:hover { border-color: var(--muted); }
        .skin-card.equipped { border-color: var(--accent); }

        .skin-preview {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: var(--surface);
        }

        .skin-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .skin-preview .skin-letter {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 52px;
            line-height: 1;
        }
        .skin-preview .skin-letter.x { color: var(--x-color); }
        .skin-preview .skin-letter.o { color: var(--o-color); }

        .skin-info {
            padding: 10px;
            border-top: 1px solid var(--border);
        }

        .skin-name {
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .skin-action {
            width: 100%;
            padding: 7px;
            border-radius: 6px;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.15s;
        }

        .skin-action.buy {
            background: transparent;
            color: var(--accent);
            border-color: var(--accent);
        }
        .skin-action.buy:hover { background: rgba(212,168,67,0.1); }
        .skin-action.buy:disabled { opacity: 0.35; cursor: default; }

        .skin-action.equip {
            background: transparent;
            color: var(--muted);
            border-color: var(--border);
        }
        .skin-action.equip:hover { color: var(--text); border-color: var(--muted); }

        .skin-action.equipped-tag {
            background: rgba(212,168,67,0.08);
            color: var(--accent);
            border-color: var(--accent);
            cursor: default;
        }

        .shop-error-msg {
            font-size: 12px;
            color: var(--x-color);
            text-align: center;
            margin-top: 12px;
            min-height: 18px;
            letter-spacing: 1px;
        }
        /* ‚îÄ‚îÄ RANK LADDER MODAL ‚îÄ‚îÄ */
        #rankModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #rankModal.show { display: flex; }

        .rank-modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 28px 24px;
            width: 280px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .rank-modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 2px;
            margin-bottom: 20px;
            color: var(--text);
        }

        .rank-ladder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }

        .rank-ladder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            transition: background 0.15s;
        }
        .rank-ladder-item.current-rank {
            background: rgba(255,255,255,0.07);
            outline: 1px solid rgba(255,255,255,0.15);
        }
        .rank-ladder-item img {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }
        .rank-ladder-name {
            font-size: 13px;
            flex: 1;
        }
        .rank-ladder-mmr {
            font-size: 11px;
            color: var(--muted);
        }
        .rank-ladder-connector {
            width: 2px;
            height: 14px;
            background: var(--border);
            margin-left: 23px; /* aligns with center of icon */
        }

        .rank-modal-close {
            position: absolute;
            top: 14px;
            right: 16px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 18px;
            cursor: pointer;
            line-height: 1;
        }
        .rank-modal-close:hover { color: var(--text); }
        
        /* ‚îÄ‚îÄ ICON PICKER MODAL ‚îÄ‚îÄ */
        #iconPickerModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }
        #iconPickerModal.show { display: flex; }

        .icon-picker-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 28px 24px;
            width: 320px;
            position: relative;
        }

        .icon-picker-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            letter-spacing: 2px;
            margin-bottom: 6px;
        }

        .icon-picker-sub {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 20px;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .icon-option {
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.15s, transform 0.1s;
            overflow: hidden;
            aspect-ratio: 1;
        }
        .icon-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .icon-option:hover { border-color: var(--muted); transform: scale(1.05); }
        .icon-option.selected { border-color: var(--accent); }

        .icon-picker-confirm {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            letter-spacing: 2px;
            color: #1a1a1a;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .icon-picker-confirm:hover { opacity: 0.85; }
        .icon-picker-confirm:disabled { opacity: 0.4; cursor: default; }

        .icon-picker-close {
            position: absolute;
            top: 14px;
            right: 16px;
            background: none;
            border: none;
            color: var(--muted);
            font-size: 18px;
            cursor: pointer;
        }
        .icon-picker-close:hover { color: var(--text); }
        </style>
</head>
<body>
<div class="wrapper">

    <!-- HEADER -->
    <header class="site-header">
        <div class="logo">‚àû TTT<span class="version-tag">v1.6</span></div>
        <div class="header-btns" id="headerBtns" style="display:none">
            <button class="btn" onclick="openShop()">Shop</button>
            <button class="btn primary" onclick="showLeaderboard()">Leaderboard</button>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen">
        <p class="login-eyebrow">Online Multiplayer</p>
        <h1 class="login-title">Infinite<br>Tic-Tac-Toe</h1>
        <p class="login-sub">Pieces vanish. Strategy evolves. No draws.</p>

        <div class="field">
            <label>Username</label>
            <input type="text" id="username" placeholder="enter username" maxlength="20">
        </div>
        <div class="field">
            <label>Password</label>
            <input type="password" id="password" placeholder="enter password" maxlength="50">
        </div>
        <button class="login-btn" onclick="login()">Play ‚Üí</button>
        <p class="login-hint">New accounts created automatically</p>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen">
        <!-- User bar -->
        <div class="user-bar">
            <div class="user-left">
                <img id="userRankIcon" class="rank-icon" src="/static/ranks/bronze3.png" alt="Rank" title="Click to view all ranks" style="cursor:pointer;" onclick="toggleRankModal()">
                <img id="userIconImg" src="/static/icons/icon1.png" alt="Profile Icon" title="Click to change icon" style="width:36px;height:36px;border-radius:8px;object-fit:cover;cursor:pointer;" onclick="openIconPicker()">
                <div style="flex:1;">
                    <div class="user-name-display" id="displayUsername"></div>
                    <div class="user-stats-bar">
                        <span class="stat-w">W: <span id="userWins">0</span></span> ¬∑
                        <span class="stat-l">L: <span id="userLosses">0</span></span> ¬∑
                        <span class="stat-r"><span id="userRank" class="rank-badge">Bronze 3</span></span> ¬∑
                        <span id="userMmr" style="color:var(--muted);font-size:11px;">1000 MMR</span> ¬∑
                        <span id="userCoins" style="color:var(--accent);font-size:11px;">‚¨° 0</span>
                    </div>
                    <!-- MMR progress bar -->
                    <div id="mmrBarWrap" style="margin-top:6px;max-width:280px;">
                        <div style="position:relative;height:5px;background:var(--border);border-radius:99px;overflow:hidden;">
                            <div id="mmrBarFill" style="height:100%;border-radius:99px;background:#ffffff;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Players bar -->
        <div class="players-bar" id="playersBar">
            <div class="player-tag">
                <img id="xPlayerIcon" src="/static/icons/icon1.png" alt="" style="width:28px;height:28px;border-radius:6px;object-fit:cover;margin-right:6px;">
                <div class="piece-icon x">X</div>
                <span class="player-tag-name" id="xPlayer">‚Äî</span>
            </div>
            <div class="vs-text">VS</div>
            <div class="player-tag right">
                <span class="player-tag-name" id="oPlayer">‚Äî</span>
                <div class="piece-icon o">O</div>
                <img id="oPlayerIcon" src="/static/icons/icon1.png" alt="" style="width:28px;height:28px;border-radius:6px;object-fit:cover;margin-left:6px;">
            </div>
        </div>

        <!-- Match score (Best of 3) -->
        <div class="match-bar" id="matchBar">
            <span class="match-label">Best of 3</span>
            <div class="match-scores">
                <div class="match-pip-group" id="xPips">
                    <div class="match-pip" id="xPip0"></div>
                    <div class="match-pip" id="xPip1"></div>
                </div>
                <div class="match-divider">‚Äî</div>
                <div class="match-pip-group" id="oPips">
                    <div class="match-pip" id="oPip0"></div>
                    <div class="match-pip" id="oPip1"></div>
                </div>
            </div>
        </div>

        <!-- Turn timer -->
        <div class="timer-bar" id="timerBar">
            <div class="timer-track">
                <div class="timer-fill" id="timerFill"></div>
            </div>
            <div class="timer-num" id="timerNum">15</div>
        </div>

        <!-- Status -->
        <div id="status" class="waiting">Click Find Game to start</div>

        <!-- Find game button -->
        <button class="find-btn" id="findGameBtn">Find Game</button>

        <!-- Game layout -->
        <div class="game-layout" id="gameLayout">
            <!-- Board -->
            <div class="board-section">
                <div id="board"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot solid"></div> Active piece</div>
                    <div class="legend-item"><div class="legend-dot faded"></div> Disappears next turn</div>
                </div>
            </div>

            <!-- Chat -->
            <div class="chat-section">
                <div class="chat-box">
                    <div class="chat-head">
                        <div class="chat-head-left">
                            <div class="chat-dot"></div>
                            <span>Chat</span>
                            <span class="unread-pill" id="unreadPill">0</span>
                        </div>
                        <button class="chat-toggle-btn" onclick="toggleChat()">Minimize</button>
                    </div>
                    <div id="chatMessages"></div>
                    <div class="chat-input-row" id="chatInputRow">
                        <input type="text" id="chatInput" placeholder="say something..." maxlength="200">
                        <button id="sendBtn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- END SCREEN / REMATCH -->
    <div class="end-overlay" id="endOverlay">
        <div class="end-box">
            <div class="end-emoji" id="endEmoji">üèÜ</div>
            <div class="end-title" id="endTitle">You Won!</div>
            <div class="end-sub" id="endSub">Great game</div>
            <div class="end-match-score" id="endMatchScore"></div>
            <div class="end-btns">
                <button class="rematch-btn" id="rematchBtn" onclick="requestRematch()">Rematch</button>
                <button class="leave-btn" onclick="leaveGame()">Leave</button>
            </div>
            <div class="rematch-waiting" id="rematchWaiting"></div>
        </div>
    </div>

    <!-- LEADERBOARD MODAL -->
    <div class="modal-overlay" id="lbModal">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title">Leaderboard</div>
                <button class="modal-close" onclick="closeLeaderboard()">‚úï</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Player</th>
                        <th>Rank</th>
                        <th>Wins</th>
                        <th>Losses</th>
                    </tr>
                </thead>
                <tbody id="lbBody">
                    <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- DEBUG TOGGLE -->
    <button id="debugToggle" onclick="toggleDebug()">Debug</button>

    <!-- DEBUG CONSOLE -->
    <div id="debugConsole">
        <div class="dbg-header">
            <span class="dbg-title">‚¨° Debug Console</span>
            <button class="dbg-close" onclick="toggleDebug()">‚úï</button>
        </div>
        <div class="dbg-state" id="dbgState">
            loading...
        </div>
        <div id="dbgLog"></div>
        <div class="dbg-footer">
            <button class="dbg-btn" onclick="dbgClear()">Clear</button>
            <button class="dbg-btn" onclick="dbgDumpState()">Dump State</button>
        </div>
    </div>

</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js">
</script>

    <!-- Shop Modal -->
    <div id="shopModal">
        <div class="shop-box">
            <div class="shop-head">
                <div class="shop-title-row">
                    <span class="shop-title">SHOP</span>
                    <span class="shop-coins" id="shopCoinsDisplay">‚¨° 0 coins</span>
                </div>
                <button class="shop-close" onclick="closeShop()">‚úï</button>
                <div class="shop-tabs">
                    <button class="shop-tab active" id="tabCross" onclick="switchShopTab('cross')">‚úï Cross</button>
                    <button class="shop-tab" id="tabCircle" onclick="switchShopTab('circle')">‚óã Circle</button>
                </div>
            </div>
            <div class="shop-body">
                <div class="skin-grid" id="skinGrid"></div>
                <div class="shop-error-msg" id="shopError"></div>
            </div>
        </div>
    </div>

    <!-- Icon Picker Modal -->
    <div id="iconPickerModal">
        <div class="icon-picker-box">
            <button class="icon-picker-close" onclick="closeIconPicker()">‚úï</button>
            <div class="icon-picker-title">CHOOSE ICON</div>
            <div class="icon-picker-sub">Your icon is permanent ‚Äî pick wisely.</div>
            <div class="icon-grid" id="iconGrid"></div>
            <button class="icon-picker-confirm" id="iconConfirmBtn" onclick="confirmIconChange()" disabled>Confirm</button>
        </div>
    </div>

    <!-- Rank Ladder Modal -->
    <div id="rankModal">
        <div class="rank-modal-box">
            <button class="rank-modal-close" onclick="toggleRankModal()">‚úï</button>
            <div class="rank-modal-title">RANK LADDER</div>
            <div class="rank-ladder" id="rankLadder"></div>
        </div>
    </div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DEBUG CONSOLE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const VERSION = 'v2.28/Alpha - Custom';
    document.querySelector('.version-tag').textContent = VERSION;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RANK SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getRankInfo(mmr) {
        const ranks = [
            { name: 'Bronze 3', mmr: 0, icon: 'bronze3.png' },
            { name: 'Bronze 2', mmr: 1100, icon: 'bronze2.png' },
            { name: 'Bronze 1', mmr: 1200, icon: 'bronze1.png' },
            { name: 'Silver 3', mmr: 1300, icon: 'silver3.png' },
            { name: 'Silver 2', mmr: 1400, icon: 'silver2.png' },
            { name: 'Silver 1', mmr: 1500, icon: 'silver1.png' },
            { name: 'Gold 3', mmr: 1600, icon: 'gold3.png' },
            { name: 'Gold 2', mmr: 1700, icon: 'gold2.png' },
            { name: 'Gold 1', mmr: 1800, icon: 'gold1.png' },
            { name: 'Ruby 3', mmr: 1900, icon: 'ruby3.png' },
            { name: 'Ruby 2', mmr: 2000, icon: 'ruby2.png' },
            { name: 'Ruby 1', mmr: 2100, icon: 'ruby1.png' },
            { name: 'Obsidian 3', mmr: 2250, icon: 'obsidian3.png' },
            { name: 'Obsidian 2', mmr: 2400, icon: 'obsidian2.png' },
            { name: 'Obsidian 1', mmr: 2550, icon: 'obsidian1.png' },
            { name: 'Onyx 3', mmr: 2700, icon: 'onyx3.png' },
            { name: 'Onyx 2', mmr: 2850, icon: 'onyx2.png' },
            { name: 'Onyx 1', mmr: 3000, icon: 'onyx1.png' },
            { name: 'Apex', mmr: 4500, icon: 'apex.png' }
        ];
        
        // Find the highest rank the player qualifies for
        let rankData = { name: 'Bronze 3', icon: 'bronze3.png' };
        for (let i = ranks.length - 1; i >= 0; i--) {
            if (mmr >= ranks[i].mmr) {
                rankData = ranks[i];
                break;
            }
        }
        return rankData;
    }
    
    function getRankName(mmr) {
        return getRankInfo(mmr).name;
    }

    function getRankColor(mmr) {
        if (mmr >= 4500) return '#8d062d'; // Apex
        if (mmr >= 3000) return '#1a1a2e'; // Onyx
        if (mmr >= 2250) return '#2d1b3d'; // Obsidian
        if (mmr >= 1900) return '#8b1538'; // Ruby
        if (mmr >= 1600) return '#d4af37'; // Gold
        if (mmr >= 1300) return '#c0c0c0'; // Silver
        return '#cd7f32'; // Bronze
    }

    // Sub-rank floor: the bottom threshold of the player's current sub-rank.
    // Used as the left edge of the progress bar so it acts like a per-rank XP bar.
    function getRankFloor(mmr) {
        // All sub-rank thresholds in ascending order ‚Äî floor is the highest one <= mmr
        const thresholds = [0,1100,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,2250,2400,2550,2700,2850,3000,4500];
        let floor = 0;
        for (const t of thresholds) {
            if (mmr >= t) floor = t;
            else break;
        }
        return floor;
    }

    // Next rank threshold above current MMR (for progress bar ceiling)
    function getNextRankThreshold(mmr) {
        const thresholds = [1100,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,2250,2400,2550,2700,2850,3000,4500];
        for (const t of thresholds) { if (mmr < t) return t; }
        return mmr; // Already at Apex ceiling
    }

    function toggleDebug() {
        document.getElementById('debugConsole').classList.toggle('open');
    }

    function dbg(msg, type = 'info') {
        const log = document.getElementById('dbgLog');
        const el  = document.createElement('div');
        el.className = `dl ${type}`;
        const t = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        el.innerHTML = `<span class="dl-t">${t}</span>${escHtml(String(msg))}`;
        log.appendChild(el);
        log.scrollTop = log.scrollHeight;
        // Keep max 200 lines
        while (log.children.length > 200) log.removeChild(log.firstChild);
    }

    function dbgUpdateState() {
        const s = document.getElementById('dbgState');
        const boardStr = board.map((v,i) => v ? `<span class="v${v.mark.toLowerCase()}">${v.mark}</span>` : '¬∑').join(' ');
        const orderStr = moveOrder.map(m => `<span class="v${m.mark.toLowerCase()}">${m.mark}@${m.index}</span>`).join(' ');
        s.innerHTML = `
            <div>ver: <span class="v">${VERSION}</span></div>
            <div>myMark: <span class="v${myMark ? myMark.toLowerCase() : ''}">${myMark || '‚Äî'}</span></div>
            <div>isMyTurn: <span class="${isMyTurn ? 'vg' : 'v'}">${isMyTurn}</span></div>
            <div>gameId: <span class="v">${gameId ? gameId.slice(0,8)+'‚Ä¶' : '‚Äî'}</span></div>
            <div>board: <span class="v">${boardStr}</span></div>
            <div>order: <span class="v">${orderStr || '‚Äî'}</span></div>
            <div>match: <span class="vx">X:${matchScore.X}</span> <span class="vo">O:${matchScore.O}</span></div>
            <div>timer: <span class="v">${timerLeft}s</span> running:<span class="v">${timerInterval !== null}</span></div>
        `;
    }

    function dbgClear() { document.getElementById('dbgLog').innerHTML = ''; }

    function dbgDumpState() {
        dbg('=== STATE DUMP ===', 'warn');
        dbg(`myMark=${myMark} isMyTurn=${isMyTurn} gameId=${gameId}`, 'warn');
        dbg(`board=[${board.map((v,i)=>v?v.mark:'_').join(',')}]`, 'warn');
        dbg(`moveOrder=[${moveOrder.map(m=>m.mark+'@'+m.index).join(',')}]`, 'warn');
        dbg(`match X:${matchScore.X} O:${matchScore.O} round:${roundNumber}`, 'warn');
        dbg(`timer: left=${timerLeft} running=${timerInterval!==null}`, 'warn');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const socket = io();

    let gameId       = null;
    let myMark       = null;
    let username     = null;
    let myIcon       = 'icon1.png';
    let myCoins      = 0;
    let myOwnedCross  = new Set(['default']);
    let myOwnedCircle = new Set(['default']);
    let myEquippedCross  = 'default';
    let myEquippedCircle = 'default';
    let gameSkins = { x_cross: 'default', x_circle: 'default', o_cross: 'default', o_circle: 'default' };
    let opponentName = null;
    let isMyTurn     = false;
    let userStats    = { wins: 0, losses: 0, rank: 1000 };
    let isChatMinimized = false;
    let unreadCount  = 0;

    const MATCH_WINS_NEEDED = 2;
    let matchScore  = { X: 0, O: 0 };
    let roundNumber = 0;

    const TURN_TIME   = 15;
    let timerInterval = null;
    let timerLeft     = TURN_TIME;

    // Board state ‚Äî ONLY updated by applyServerMove(), never optimistically
    let board     = Array(9).fill(null);  // null | { mark }
    let moveOrder = [];                   // [{ mark, index }, ...] oldest first

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SOUND ENGINE (WAV files)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const sounds = {};
    ['place','remove','win','lose','draw','tick','gamestart'].forEach(name => {
        const audio = new Audio(`/static/sounds/${name}.wav`);
        audio.preload = 'auto';
        sounds[name] = audio;
    });

    function playSound(type) {
        try {
            const snd = sounds[type];
            if (!snd) return;
            snd.currentTime = 0;
            snd.play().catch(() => {});
        } catch(e) {}
    }

    const WIN_LINES = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
    ];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.onload = () => {
        dbg(`${VERSION} loaded`, 'ok');
        const u = localStorage.getItem('tttUser');
        const p = localStorage.getItem('tttPass');
        if (u && p) {
            document.getElementById('username').value = u;
            document.getElementById('password').value = p;
            login();
        }
        document.getElementById('username').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        document.getElementById('password').addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
        document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
        buildBoard();
        dbgUpdateState();
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function login() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if (!u || !p) { alert('Enter username and password'); return; }
        dbg(`login attempt: ${u}`, 'info');
        socket.emit('login', { username: u, password: p });
    }

    socket.on('login_success', data => {
        username  = data.username;
        userStats = data.stats;
        myIcon    = data.icon || 'icon1.png';
        if (data.cosmetics) {
            myCoins          = data.stats.coins || 0;
            myOwnedCross     = new Set((data.cosmetics.owned_cross  || 'default').split(','));
            myOwnedCircle    = new Set((data.cosmetics.owned_circle || 'default').split(','));
            myEquippedCross  = data.cosmetics.equipped_cross  || 'default';
            myEquippedCircle = data.cosmetics.equipped_circle || 'default';
        }
        localStorage.setItem('tttUser', username);
        localStorage.setItem('tttPass', document.getElementById('password').value);
        dbg(`logged in as ${username}`, 'ok');
        showGameScreen();
    });

    socket.on('login_failed', data => {
        dbg(`login failed: ${data.message}`, 'err');
        alert(data.message);
    });

    // Kicked because this account was logged in from another tab/device
    socket.on('force_logout', data => {
        dbg('force_logout ‚Äî session taken over by another tab', 'err');

        // Clear stored credentials so page doesn't auto-login in a loop
        localStorage.removeItem('tttUser');
        localStorage.removeItem('tttPass');

        // Stop any active game timer
        stopTimer();

        // Show a full-screen overlay (non-blocking, so the new tab isn't paused)
        const banner = document.createElement('div');
        banner.style.cssText = [
            'position:fixed', 'inset:0', 'z-index:99999',
            'background:rgba(0,0,0,0.9)', 'backdrop-filter:blur(8px)',
            'display:flex', 'flex-direction:column',
            'align-items:center', 'justify-content:center', 'gap:16px',
            "font-family:'DM Mono',monospace", 'color:#e8e8f0'
        ].join(';') + ';';
        const msg = data.message || 'You were logged in from another tab or device.';
        banner.innerHTML =
            '<div style="font-family:Bebas Neue,sans-serif;font-size:40px;letter-spacing:3px;color:#ff4d6d;">Session Ended</div>' +
            '<div style="font-size:14px;color:#5a5a7a;max-width:320px;text-align:center;">' + msg + '</div>' +
            '<button onclick="location.reload()" style="margin-top:8px;padding:12px 32px;background:#f0c060;border:none;border-radius:8px;font-family:Bebas Neue,sans-serif;font-size:20px;letter-spacing:2px;color:#1a1a1a;cursor:pointer;">Back to Login</button>';
        document.body.appendChild(banner);
    });

    function logout() {
        if (!confirm('Logout?')) return;
        localStorage.removeItem('tttUser');
        localStorage.removeItem('tttPass');
        location.reload();
    }

    function showGameScreen() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('gameScreen').classList.add('show');
        document.getElementById('headerBtns').style.display = 'flex';
        document.getElementById('displayUsername').textContent = username;
        document.getElementById('userIconImg').src = `/static/icons/${myIcon}`;
        updateStatsDisplay();
    }

    function updateStatsDisplay() {
        const mmr = userStats.rank;
        document.getElementById('userWins').textContent   = userStats.wins;
        document.getElementById('userLosses').textContent = userStats.losses;

        // Update rank badge
        const rankInfo  = getRankInfo(mmr);
        const rankColor = getRankColor(mmr);
        const rankEl    = document.getElementById('userRank');
        rankEl.textContent       = rankInfo.name;
        rankEl.style.backgroundColor = rankColor;
        rankEl.style.color       = '#fff';
        rankEl.title             = `${mmr} MMR`;

        // Update rank icon
        const rankIconEl = document.getElementById('userRankIcon');
        rankIconEl.src   = `/static/ranks/${rankInfo.icon}`;
        rankIconEl.alt   = rankInfo.name;
        rankIconEl.title = `${rankInfo.name} (${mmr} MMR)`;

        // Update MMR label
        document.getElementById('userMmr').textContent = `${mmr} MMR`;
        document.getElementById('userCoins').textContent = `‚¨° ${userStats.coins !== undefined ? userStats.coins : myCoins}`;

        // ‚îÄ‚îÄ MMR progress bar with tier floor indicator ‚îÄ‚îÄ
        const floor = getRankFloor(mmr);
        const next  = getNextRankThreshold(mmr);
        const isApex = mmr >= 4500;

        // Progress within the current segment (floor ‚Üí next threshold)
        const segLen  = isApex ? 1 : (next - floor);
        const segPos  = isApex ? 1 : Math.max(0, mmr - floor);
        const pct     = isApex ? 100 : Math.min(100, Math.round((segPos / segLen) * 100));

        // Fill bar
        const fill = document.getElementById('mmrBarFill');
        fill.style.width      = pct + '%';
        fill.style.background = '#ffffff';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MATCHMAKING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('findGameBtn').addEventListener('click', () => {
        dbg('finding game...', 'info');
        setStatus('Searching for opponent...', 'waiting');
        socket.emit('find_game', { username });
    });

    socket.on('waiting', data => {
        dbg('in waiting room', 'info');
        setStatus(data.message, 'waiting');
    });

    socket.on('game_start', data => {
        dbg(`game_start: mark=${data.mark} first=${data.first_turn} new_match=${data.new_match}`, 'evt');

        gameId       = data.game_id;
        myMark       = data.mark;
        opponentName = data.opponent_name || 'Opponent';
        isMyTurn     = (data.first_turn === myMark);

        if (data.new_match) {
            matchScore  = { X: 0, O: 0 };
            roundNumber = 0;
        }
        roundNumber++;

        // Reset board state completely
        board     = Array(9).fill(null);
        moveOrder = [];

        document.getElementById('findGameBtn').style.display = 'none';
        document.getElementById('playersBar').classList.add('show');
        document.getElementById('matchBar').classList.add('show');
        document.getElementById('timerBar').classList.add('show');
        document.getElementById('gameLayout').classList.add('show');
        document.getElementById('endOverlay').classList.remove('show');
        document.getElementById('xPlayer').textContent = data.x_player;
        document.getElementById('oPlayer').textContent = data.o_player;
        document.getElementById('xPlayerIcon').src = `/static/icons/${data.x_icon || 'icon1.png'}`;
        document.getElementById('oPlayerIcon').src = `/static/icons/${data.o_icon || 'icon1.png'}`;
        gameSkins = {
            x_cross:  data.x_cross  || 'default',
            x_circle: data.x_circle || 'default',
            o_cross:  data.o_cross  || 'default',
            o_circle: data.o_circle || 'default',
        };

        updateMatchPips();
        resetBoardDOM();
        updateStatus();
        startTimer();
        playSound('gamestart');
        addSysMsg(`Round ${roundNumber} ‚Äî You are ${myMark}. ${isMyTurn ? 'You go first!' : `${opponentName} goes first.`}`);
        dbg(`game started ‚Äî I am ${myMark}, my turn: ${isMyTurn}`, 'ok');
        dbgUpdateState();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  BOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildBoard() {
        const el = document.getElementById('board');
        el.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.index = i;
            cell.addEventListener('click', () => handleCellClick(i));
            el.appendChild(cell);
        }
    }

    function resetBoardDOM() {
        document.querySelectorAll('.cell').forEach(c => {
            c.innerHTML = '';
            c.className = 'cell';
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CLICK ‚Äî optimistic render + send to server
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function handleCellClick(index) {
        if (!gameId)     { dbg('click ignored: no gameId', 'warn'); return; }
        if (!isMyTurn)   { dbg(`click ignored: not my turn (cell ${index})`, 'warn'); return; }
        if (board[index]){ dbg(`click ignored: cell ${index} occupied`, 'warn'); return; }

        dbg(`clicking cell ${index}`, 'move');

        // ‚îÄ‚îÄ OPTIMISTIC RENDER (instant, no server wait) ‚îÄ‚îÄ
        // Animate removal of oldest piece if we already have 3
        const myPieces = moveOrder.filter(m => m.mark === myMark);
        if (myPieces.length >= 3) {
            const oldest = myPieces[0];
            const oldCell = getCell(oldest.index);
            if (oldCell) {
                const oldPiece = oldCell.querySelector('.piece');
                if (oldPiece) {
                    playSound('remove');
                    oldPiece.classList.add('vanishing');
                    setTimeout(() => { oldCell.innerHTML = ''; oldCell.className = 'cell'; }, 220);
                }
            }
        }
        // Show piece immediately
        renderCell(index, myMark);
        playSound('place');

        // Lock turn to prevent double-click
        isMyTurn = false;
        stopTimer();
        updateStatus();
        socket.emit('make_move', { game_id: gameId, index });
        dbgUpdateState();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SERVER MOVE ‚Äî updates board[] and moveOrder[] state
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function applyServerMove(index, mark, forceRender = false) {
        dbg(`applyServerMove: mark=${mark} index=${index}`, 'move');
        dbg(`  before: order=[${moveOrder.map(m=>m.mark+'@'+m.index).join(',')}]`, 'info');

        const pieces = moveOrder.filter(m => m.mark === mark);
        const isOwnMove = (mark === myMark);

        // Remove oldest piece if player already has 3
        if (pieces.length >= 3) {
            const oldest = pieces[0];
            dbg(`  removing oldest ${mark}@${oldest.index}`, 'warn');
            board[oldest.index] = null;
            moveOrder = moveOrder.filter(m => !(m.mark === mark && m.index === oldest.index));

            if (!isOwnMove || forceRender) {
                // Animate opponent removal visually
                const oldCell = getCell(oldest.index);
                if (oldCell) {
                    const oldPiece = oldCell.querySelector('.piece');
                    if (oldPiece) {
                        playSound('remove');
                        oldPiece.classList.add('vanishing');
                        setTimeout(() => {
                            if (oldCell) { oldCell.innerHTML = ''; oldCell.className = 'cell'; }
                        }, 220);
                    }
                }
            }
            // Own removal already animated optimistically in handleCellClick
        }

        // Update state
        board[index] = { mark };
        moveOrder.push({ mark, index });

        // Only render cell for opponent ‚Äî own piece already shown optimistically
        if (!isOwnMove || forceRender) {
            renderCell(index, mark);
        }

        // Safety: ensure authoritative server move is always visible locally
        const placedCell = getCell(index);
        if (!placedCell || !placedCell.querySelector('.piece')) {
            renderCell(index, mark);
        }

        // Refresh fading indicators for this mark
        const current = moveOrder.filter(m => m.mark === mark);
        current.forEach((m, i) => {
            markFading(m.index, i === 0 && current.length >= 3);
        });

        dbg(`  after: order=[${moveOrder.map(m=>m.mark+'@'+m.index).join(',')}]`, 'info');
        dbg(`  board=[${board.map((v,i)=>v?v.mark:'_').join(',')}]`, 'info');
        dbgUpdateState();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SOCKET: MOVE MADE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    socket.on('move_made', data => {
        const { index, mark, game_over, winner, win_line, stats, timeout } = data;
        dbg(`move_made: mark=${mark} idx=${index} game_over=${game_over} winner=${winner} timeout=${timeout}`, 'evt');

        if (index !== null && index !== undefined) {
            applyServerMove(index, mark, Boolean(timeout));
        }

        if (game_over) {
            dbg(`GAME OVER ‚Äî winner=${winner} line=${JSON.stringify(win_line)}`, 'ok');
            isMyTurn = false;
            stopTimer();

            if (stats) {
                userStats = stats;
                if (stats.coins !== undefined) myCoins = stats.coins;
                if (stats.equipped_cross)  myEquippedCross  = stats.equipped_cross;
                if (stats.equipped_circle) myEquippedCircle = stats.equipped_circle;
                updateStatsDisplay();
            }

            if (winner && winner !== 'draw') {
                matchScore[winner]++;
                updateMatchPips();
            }

            const matchOver = matchScore.X >= MATCH_WINS_NEEDED || matchScore.O >= MATCH_WINS_NEEDED;
            dbg(`matchOver=${matchOver} scores X:${matchScore.X} O:${matchScore.O}`, 'state');

            setTimeout(() => { if (win_line) highlightWin(win_line); }, 150);

            if (matchOver) {
                // Show end screen only when match is fully decided
                setTimeout(() => showEndScreen(winner, true), 700);
            } else {
                // Between rounds: just show a message ‚Äî server auto-starts next round
                const roundMsg = winner === myMark ? `Round ${roundNumber} ‚Äî You won! üéâ` : `Round ${roundNumber} ‚Äî You lost.`;
                addSysMsg(roundMsg);
                dbg('waiting for server to start next round...', 'info');
            }

        } else {
            isMyTurn = (mark !== myMark);
            dbg(`turn switch: mark played=${mark}, myMark=${myMark}, isMyTurn=${isMyTurn}`, 'turn');
            updateStatus();
            startTimer();
            dbgUpdateState();
        }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RENDERING HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getSkinSrc(mark, pieceType) {
        const key = mark.toLowerCase() + '_' + pieceType;
        const skin = gameSkins[key] || 'default';
        return `/static/piece/${pieceType}/${skin}.png`;
    }

    function renderCell(index, mark) {
        const cell = getCell(index);
        if (!cell) { dbg(`renderCell: no cell at ${index}!`, 'err'); return; }
        cell.classList.add('taken');
        const pieceType = mark === 'X' ? 'cross' : 'circle';
        const span = document.createElement('span');
        span.className = `piece ${mark.toLowerCase()} just-placed`;
        const img = document.createElement('img');
        img.src = getSkinSrc(mark, pieceType);
        img.alt = mark;
        img.style.cssText = 'width:65%;height:65%;object-fit:contain;display:block;';
        img.onerror = () => { img.remove(); span.textContent = mark; };
        span.appendChild(img);
        cell.innerHTML = '';
        cell.appendChild(span);
    }

    function markFading(index, shouldFade) {
        const cell  = getCell(index);
        if (!cell) return;
        const piece = cell.querySelector('.piece');
        if (!piece) return;
        if (shouldFade) {
            cell.classList.add('fading-cell');
            piece.classList.add('fading');
        } else {
            cell.classList.remove('fading-cell');
            piece.classList.remove('fading');
        }
    }

    function getCell(index) {
        return document.querySelector(`.cell[data-index="${index}"]`);
    }

    function highlightWin(line) {
        dbg(`highlighting win line: ${JSON.stringify(line)}`, 'ok');
        line.forEach(i => {
            const cell = getCell(i);
            if (cell) cell.classList.add('win-cell');
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TIMER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function startTimer() {
        stopTimer();
        timerLeft = TURN_TIME;
        renderTimer();
        timerInterval = setInterval(() => {
            timerLeft--;
            renderTimer();
            dbgUpdateState();
            if (timerLeft <= 0) {
                stopTimer();
                dbg(`timer expired ‚Äî isMyTurn=${isMyTurn}`, 'warn');
                if (isMyTurn && gameId) {
                    dbg('emitting timeout', 'warn');
                    isMyTurn = false;
                    socket.emit('timeout', { game_id: gameId });
                    dbgUpdateState();
                }
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function renderTimer() {
        const fill = document.getElementById('timerFill');
        const num  = document.getElementById('timerNum');
        const pct  = (timerLeft / TURN_TIME) * 100;
        fill.style.width = pct + '%';
        num.textContent  = timerLeft;
        const urgent = timerLeft <= 5;
        if (urgent && timerLeft > 0) playSound('tick');
        fill.classList.toggle('urgent', urgent);
        num.classList.toggle('urgent', urgent);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MATCH PIPS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateMatchPips() {
        ['X', 'O'].forEach(mark => {
            const wins = matchScore[mark];
            const p    = mark.toLowerCase();
            for (let i = 0; i < 2; i++) {
                const pip = document.getElementById(`${p}Pip${i}`);
                if (pip) pip.className = 'match-pip' + (i < wins ? ` won-${p}` : '');
            }
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  END SCREEN / REMATCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showEndScreen(winner, matchOver) {
        const isWinner = winner === myMark;
        const isDraw   = winner === 'draw';
        dbg(`showEndScreen: winner=${winner} myMark=${myMark} matchOver=${matchOver}`, 'state');

        document.getElementById('endEmoji').textContent  = isWinner ? 'üèÜ' : isDraw ? 'ü§ù' : 'üòû';
        document.getElementById('endTitle').textContent  = isWinner ? 'You Won!' : isDraw ? 'Draw!' : 'You Lost';
        document.getElementById('endTitle').style.color  = isWinner ? 'var(--accent)' : isDraw ? 'var(--text)' : 'var(--muted)';
        playSound(isWinner ? 'win' : isDraw ? 'draw' : 'lose');

        const myScore  = matchScore[myMark];
        const oppScore = matchScore[myMark === 'X' ? 'O' : 'X'];
        document.getElementById('endMatchScore').innerHTML = `Match: <span>${myScore}</span> ‚Äî <span>${oppScore}</span>`;
        document.getElementById('endSub').textContent = matchOver
            ? (isWinner ? 'You won the match! üéâ' : `${opponentName} won the match`)
            : `Round ${roundNumber} of 3`;
        document.getElementById('rematchBtn').textContent = matchOver ? 'New Match' : 'Next Round';
        document.getElementById('rematchBtn').disabled    = false;
        document.getElementById('rematchWaiting').textContent = '';

        addSysMsg(isWinner ? 'You won! üéâ' : isDraw ? 'Draw!' : 'You lost.');
        document.getElementById('endOverlay').classList.add('show');
    }

    function requestRematch() {
        dbg('requesting rematch', 'info');
        document.getElementById('rematchBtn').disabled = true;
        document.getElementById('rematchWaiting').textContent = 'Waiting for opponent...';
        socket.emit('rematch_request', { game_id: gameId });
    }

    function leaveGame() {
        dbg('leaving game', 'warn');
        // Notify server to cancel any rematch and clean up
        if (gameId) {
            socket.emit('leave_game', { game_id: gameId });
        }
        document.getElementById('endOverlay').classList.remove('show');
        fullReset();
    }

    socket.on('rematch_start', data => {
        dbg(`rematch_start: mark=${data.mark} first=${data.first_turn} new_match=${data.new_match}`, 'evt');
        gameId       = data.game_id;
        myMark       = data.mark;
        opponentName = data.opponent_name || opponentName;
        isMyTurn     = (data.first_turn === myMark);

        if (data.new_match) { matchScore = { X: 0, O: 0 }; roundNumber = 0; }
        roundNumber++;
        board     = Array(9).fill(null);
        moveOrder = [];

        document.getElementById('xPlayer').textContent = data.x_player;
        document.getElementById('oPlayer').textContent = data.o_player;
        document.getElementById('xPlayerIcon').src = `/static/icons/${data.x_icon || 'icon1.png'}`;
        document.getElementById('oPlayerIcon').src = `/static/icons/${data.o_icon || 'icon1.png'}`;
        gameSkins = {
            x_cross:  data.x_cross  || 'default',
            x_circle: data.x_circle || 'default',
            o_cross:  data.o_cross  || 'default',
            o_circle: data.o_circle || 'default',
        };
        document.getElementById('endOverlay').classList.remove('show');

        updateMatchPips();
        resetBoardDOM();
        updateStatus();
        startTimer();
        playSound('gamestart');
        addSysMsg(`‚ö° Round ${roundNumber} ‚Äî You are ${myMark}. ${isMyTurn ? 'You go first!' : `${opponentName} goes first.`}`);
        dbg(`round ${roundNumber} started ‚Äî I am ${myMark}, my turn: ${isMyTurn}`, 'ok');
        dbgUpdateState();
    });

    socket.on('rematch_declined', () => {
        dbg('rematch declined ‚Äî opponent left', 'warn');
        document.getElementById('rematchBtn').style.display = 'none';
        document.getElementById('rematchWaiting').textContent = 'Opponent left the game.';
        setTimeout(() => {
            document.getElementById('endOverlay').classList.remove('show');
            document.getElementById('rematchBtn').style.display = 'block'; // restore for next time
            fullReset();
        }, 2500);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FULL RESET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function fullReset() {
        dbg('fullReset()', 'warn');
        stopTimer();
        document.getElementById('findGameBtn').style.display = 'block';
        document.getElementById('gameLayout').classList.remove('show');
        document.getElementById('playersBar').classList.remove('show');
        document.getElementById('matchBar').classList.remove('show');
        document.getElementById('timerBar').classList.remove('show');
        document.getElementById('endOverlay').classList.remove('show');
        document.getElementById('chatMessages').innerHTML = '';
        resetBoardDOM();
        board     = Array(9).fill(null);
        moveOrder = [];
        matchScore  = { X: 0, O: 0 };
        roundNumber = 0;
        gameId      = null;
        myMark      = null;
        isMyTurn    = false;
        opponentName = null;
        setStatus('', 'waiting');
        dbgUpdateState();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATUS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setStatus(msg, cls) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = cls;
    }

    function updateStatus() {
        const xEl = document.getElementById('xPlayer');
        const oEl = document.getElementById('oPlayer');
        if (xEl && oEl) {
            if (myMark === 'X') {
                xEl.classList.toggle('active', isMyTurn);
                oEl.classList.toggle('active', !isMyTurn);
            } else {
                oEl.classList.toggle('active', isMyTurn);
                xEl.classList.toggle('active', !isMyTurn);
            }
        }
        if (isMyTurn) setStatus('Your turn', 'your-turn');
        else if (gameId) setStatus(`${opponentName || 'Opponent'}'s turn...`, 'opp-turn');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DISCONNECT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    socket.on('opponent_disconnected', () => {
        dbg('opponent disconnected', 'warn');
        stopTimer();
        addSysMsg('Opponent disconnected.');
        setStatus('Opponent disconnected', 'waiting');
        setTimeout(fullReset, 2500);
    });

    socket.on('error', data => {
        dbg(`SERVER ERROR: ${data.message}`, 'err');
        console.error('Server error:', data.message);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CHAT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const msg   = input.value.trim();
        if (!msg || !gameId) return;
        socket.emit('chat_message', { game_id: gameId, message: msg, sender: username });
        addMsg(username, msg, true);
        input.value = '';
    }

    socket.on('chat_message', data => {
        addMsg(data.sender, data.message, false);
        if (isChatMinimized) {
            unreadCount++;
            document.getElementById('unreadPill').style.display = 'inline-block';
            document.getElementById('unreadPill').textContent = unreadCount;
        }
    });

    function addMsg(sender, text, own) {
        const wrap = document.getElementById('chatMessages');
        const div  = document.createElement('div');
        div.className = `msg ${own ? 'own' : 'opp'}`;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        div.innerHTML = `<div class="msg-sender">${sender}</div><div class="msg-bubble">${escHtml(text)}</div><div class="msg-time">${time}</div>`;
        wrap.appendChild(div);
        wrap.scrollTop = wrap.scrollHeight;
    }

    function addSysMsg(text) {
        const wrap = document.getElementById('chatMessages');
        const div  = document.createElement('div');
        div.className = 'sys-msg';
        div.textContent = text;
        wrap.appendChild(div);
        wrap.scrollTop = wrap.scrollHeight;
    }

    function toggleChat() {
        isChatMinimized = !isChatMinimized;
        const msgs = document.getElementById('chatMessages');
        const row  = document.getElementById('chatInputRow');
        const btn  = document.querySelector('.chat-toggle-btn');
        msgs.style.display = isChatMinimized ? 'none' : 'flex';
        row.style.display  = isChatMinimized ? 'none' : 'flex';
        btn.textContent    = isChatMinimized ? 'Expand' : 'Minimize';
        if (!isChatMinimized) {
            unreadCount = 0;
            document.getElementById('unreadPill').style.display = 'none';
        }
    }

    function escHtml(t) {
        const d = document.createElement('div');
        d.textContent = t;
        return d.innerHTML;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LEADERBOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showLeaderboard() {
        document.getElementById('lbModal').classList.add('show');
        socket.emit('get_leaderboard');
    }

    function closeLeaderboard() {
        document.getElementById('lbModal').classList.remove('show');
    }

    socket.on('leaderboard_data', data => {
        const tbody = document.getElementById('lbBody');
        tbody.innerHTML = '';
        if (!data.leaderboard.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px">No players yet</td></tr>';
            return;
        }
        data.leaderboard.forEach((p, i) => {
            const position = i + 1;
            const rankCls = position <= 3 ? `rank-${position}` : '';
            const isMe    = p.username === username;
            const rankName = getRankName(p.rank);
            const rankColor = getRankColor(p.rank);
            const tr      = document.createElement('tr');
            if (isMe) tr.classList.add('lb-me-row');

            // SECURITY: Build cells with textContent to prevent XSS from usernames
            const tdPos = document.createElement('td');
            tdPos.className = `rank-num ${rankCls}`;
            tdPos.textContent = position;

            const tdName = document.createElement('td');
            if (isMe) tdName.className = 'lb-you';
            tdName.textContent = p.username + (isMe ? ' ‚Üê you' : '');

            const tdRank = document.createElement('td');
            const badge = document.createElement('span');
            badge.className = 'rank-badge';
            badge.style.backgroundColor = rankColor;
            badge.style.color = '#fff';
            badge.title = `${p.rank} MMR`;
            badge.textContent = rankName;
            tdRank.appendChild(badge);

            const tdWins = document.createElement('td');
            tdWins.textContent = p.wins;

            const tdLosses = document.createElement('td');
            tdLosses.textContent = p.losses;

            tr.appendChild(tdPos);
            tr.appendChild(tdName);
            tr.appendChild(tdRank);
            tr.appendChild(tdWins);
            tr.appendChild(tdLosses);
            tbody.appendChild(tr);
        });
    });

    document.getElementById('lbModal').addEventListener('click', e => {
        if (e.target === document.getElementById('lbModal')) closeLeaderboard();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RANK LADDER MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ALL_RANKS = [
        { name: 'Apex',       mmr: 4500, icon: 'apex.png' },
        { name: 'Onyx 1',     mmr: 3000, icon: 'onyx1.png' },
        { name: 'Onyx 2',     mmr: 2850, icon: 'onyx2.png' },
        { name: 'Onyx 3',     mmr: 2700, icon: 'onyx3.png' },
        { name: 'Obsidian 1', mmr: 2550, icon: 'obsidian1.png' },
        { name: 'Obsidian 2', mmr: 2400, icon: 'obsidian2.png' },
        { name: 'Obsidian 3', mmr: 2250, icon: 'obsidian3.png' },
        { name: 'Ruby 1',     mmr: 2100, icon: 'ruby1.png' },
        { name: 'Ruby 2',     mmr: 2000, icon: 'ruby2.png' },
        { name: 'Ruby 3',     mmr: 1900, icon: 'ruby3.png' },
        { name: 'Gold 1',     mmr: 1800, icon: 'gold1.png' },
        { name: 'Gold 2',     mmr: 1700, icon: 'gold2.png' },
        { name: 'Gold 3',     mmr: 1600, icon: 'gold3.png' },
        { name: 'Silver 1',   mmr: 1500, icon: 'silver1.png' },
        { name: 'Silver 2',   mmr: 1400, icon: 'silver2.png' },
        { name: 'Silver 3',   mmr: 1300, icon: 'silver3.png' },
        { name: 'Bronze 1',   mmr: 1200, icon: 'bronze1.png' },
        { name: 'Bronze 2',   mmr: 1100, icon: 'bronze2.png' },
        { name: 'Bronze 3',   mmr: 0,    icon: 'bronze3.png' },
    ];

    function toggleRankModal() {
        const modal = document.getElementById('rankModal');
        const isOpen = modal.classList.toggle('show');
        if (isOpen) buildRankLadder();
    }

    function buildRankLadder() {
        const container = document.getElementById('rankLadder');
        container.innerHTML = '';
        const currentRank = getRankName(userStats ? userStats.rank : 0);

        ALL_RANKS.forEach((rank, i) => {
            if (i > 0) {
                const connector = document.createElement('div');
                connector.className = 'rank-ladder-connector';
                container.appendChild(connector);
            }

            const item = document.createElement('div');
            item.className = 'rank-ladder-item' + (rank.name === currentRank ? ' current-rank' : '');

            const img = document.createElement('img');
            img.src = `/static/ranks/${rank.icon}`;
            img.alt = rank.name;

            const nameEl = document.createElement('span');
            nameEl.className = 'rank-ladder-name';
            nameEl.textContent = rank.name;
            if (rank.name === currentRank) nameEl.style.color = 'var(--accent)';

            const mmrEl = document.createElement('span');
            mmrEl.className = 'rank-ladder-mmr';
            mmrEl.textContent = rank.mmr === 0 ? '0+' : `${rank.mmr}+`;

            item.appendChild(img);
            item.appendChild(nameEl);
            item.appendChild(mmrEl);
            container.appendChild(item);

            if (rank.name === currentRank) {
                setTimeout(() => item.scrollIntoView({ block: 'center', behavior: 'smooth' }), 50);
            }
        });
    }

    document.getElementById('rankModal').addEventListener('click', e => {
        if (e.target === document.getElementById('rankModal')) toggleRankModal();
    });


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ICON PICKER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let pendingIcon = null;

    function openIconPicker() {
        // Only allow in menu (not during active game)
        if (gameId) return;
        buildIconGrid();
        document.getElementById('iconPickerModal').classList.add('show');
    }

    function closeIconPicker() {
        document.getElementById('iconPickerModal').classList.remove('show');
        pendingIcon = null;
        document.getElementById('iconConfirmBtn').disabled = true;
    }

    function buildIconGrid() {
        const grid = document.getElementById('iconGrid');
        grid.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            const filename = `icon${i}.png`;
            const div = document.createElement('div');
            div.className = 'icon-option' + (filename === myIcon ? ' selected' : '');
            div.dataset.icon = filename;
            div.onclick = () => selectIcon(filename);

            const img = document.createElement('img');
            img.src = `/static/icons/${filename}`;
            img.alt = `Icon ${i}`;
            div.appendChild(img);
            grid.appendChild(div);
        }
    }

    function selectIcon(filename) {
        // Deselect all, select clicked
        document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.icon-option[data-icon="${filename}"]`).classList.add('selected');
        pendingIcon = filename;
        // Only enable confirm if it's different from current
        document.getElementById('iconConfirmBtn').disabled = (filename === myIcon);
    }

    function confirmIconChange() {
        if (!pendingIcon || pendingIcon === myIcon) return;
        socket.emit('update_icon', { icon: pendingIcon });
    }

    socket.on('icon_updated', data => {
        myIcon = data.icon;
        document.getElementById('userIconImg').src = `/static/icons/${data.icon}`;
        closeIconPicker();
    });

    // Close on backdrop click
    document.getElementById('iconPickerModal').addEventListener('click', e => {
        if (e.target === document.getElementById('iconPickerModal')) closeIconPicker();
    });




    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SHOP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let shopCurrentTab = 'cross';
    let shopData = null;

    function openShop() {
        document.getElementById('shopModal').classList.add('show');
        document.getElementById('shopError').textContent = '';
        socket.emit('get_shop');
    }

    function closeShop() {
        document.getElementById('shopModal').classList.remove('show');
        document.getElementById('shopError').textContent = '';
    }

    function switchShopTab(tab) {
        shopCurrentTab = tab;
        document.getElementById('tabCross').classList.toggle('active', tab === 'cross');
        document.getElementById('tabCircle').classList.toggle('active', tab === 'circle');
        if (shopData) renderShopGrid(shopData);
    }

    socket.on('shop_data', data => {
        shopData = data;
        myCoins = data.coins;
        myEquippedCross  = data.equipped_cross;
        myEquippedCircle = data.equipped_circle;
        document.getElementById('shopCoinsDisplay').textContent = `‚¨° ${data.coins} coins`;
        document.getElementById('userCoins').textContent = `‚¨° ${data.coins}`;
        renderShopGrid(data);
    });

    function renderShopGrid(data) {
        const grid = document.getElementById('skinGrid');
        grid.innerHTML = '';
        const skins    = shopCurrentTab === 'cross' ? data.cross_skins  : data.circle_skins;
        const equipped = shopCurrentTab === 'cross' ? data.equipped_cross : data.equipped_circle;
        const pieceType  = shopCurrentTab;
        const markClass  = shopCurrentTab === 'cross' ? 'x' : 'o';
        const markLetter = shopCurrentTab === 'cross' ? 'X' : 'O';

        skins.forEach(skin => {
            const card = document.createElement('div');
            card.className = 'skin-card' + (skin.name === equipped ? ' equipped' : '');

            const preview = document.createElement('div');
            preview.className = 'skin-preview';
            const img = document.createElement('img');
            img.src = `/static/piece/${pieceType}/${skin.name}.png`;
            img.alt = skin.name;
            img.onerror = () => {
                img.remove();
                const letter = document.createElement('span');
                letter.className = `skin-letter ${markClass}`;
                letter.textContent = markLetter;
                preview.appendChild(letter);
            };
            preview.appendChild(img);

            const info = document.createElement('div');
            info.className = 'skin-info';

            const nameEl = document.createElement('div');
            nameEl.className = 'skin-name';
            nameEl.textContent = skin.name;
            info.appendChild(nameEl);

            const btn = document.createElement('button');
            if (skin.name === equipped) {
                btn.className = 'skin-action equipped-tag';
                btn.textContent = 'Equipped';
            } else if (skin.owned) {
                btn.className = 'skin-action equip';
                btn.textContent = 'Equip';
                btn.onclick = () => equipSkin(pieceType, skin.name);
            } else {
                btn.className = 'skin-action buy';
                btn.textContent = `‚¨° ${skin.price}`;
                btn.disabled = myCoins < skin.price;
                btn.onclick = () => buySkin(pieceType, skin.name);
            }
            info.appendChild(btn);

            card.appendChild(preview);
            card.appendChild(info);
            grid.appendChild(card);
        });
    }

    function buySkin(skinType, name) {
        document.getElementById('shopError').textContent = '';
        socket.emit('buy_skin', { skin_type: skinType, name });
    }

    function equipSkin(skinType, name) {
        document.getElementById('shopError').textContent = '';
        socket.emit('equip_skin', { skin_type: skinType, name });
    }

    socket.on('buy_success', data => {
        myCoins = data.coins;
        myOwnedCross  = new Set(data.owned_cross.split(','));
        myOwnedCircle = new Set(data.owned_circle.split(','));
        socket.emit('get_shop');
    });

    socket.on('equip_success', data => {
        if (data.skin_type === 'cross') myEquippedCross = data.name;
        else myEquippedCircle = data.name;
        socket.emit('get_shop');
    });

    socket.on('shop_error', data => {
        document.getElementById('shopError').textContent = data.message;
    });

    document.getElementById('shopModal').addEventListener('click', e => {
        if (e.target === document.getElementById('shopModal')) closeShop();
    });

</script>


</body>
</html>